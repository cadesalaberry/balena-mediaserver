version: "2.1"

x-s6-service: &s6-service
  restart: "on-failure"
  tmpfs:
    - /tmp
  environment: &s6-environment
    S6_VERBOSITY: 2
    PUID: "1000"
    PGID: "1000"
  entrypoint:
    - /bin/bash
    - -c
  command:
    - |
      [[ ${DISABLE,,} =~ true|yes|on|1 ]] && exit 0
      exec /init

# https://hub.docker.com/r/tailscale/tailscale
# https://github.com/tailscale/tailscale/blob/main/cmd/containerboot/main.go
# https://tailscale.com/kb/1282/docker
# https://tailscale.com/kb/1278/tailscaled
# https://tailscale.com/kb/1241/tailscale-up
# https://tailscale.com/kb/1242/tailscale-serve
# https://tailscale.com/kb/1311/tailscale-funnel
# https://tailscale.com/blog/docker-tailscale-guide
x-tailscale-service: &tailscale
  build: tailscale
  restart: "on-failure"
  cap_add:
    - NET_ADMIN
    - SYS_MODULE
  labels:
    io.balena.features.kernel-modules: 1

volumes:
  downloads: {}
  duplicati: {}
  jellyfin: {}
  letsencrypt: {}
  netdatalib: {}
  netdatacache: {}
  nzbhydra: {}
  ombi: {}
  overseerr: {}
  plex: {}
  prowlarr: {}
  proxy: {}
  radarr: {}
  sabnzbd: {}
  sonarr: {}
  syncthing: {}
  tautulli: {}
  tailscale: {}
  ts-nginx: {}
  ts-duplicati: {}
  ts-jellyfin: {}
  ts-netdata: {}
  ts-nzbhydra: {}
  ts-ombi: {}
  ts-overseerr: {}
  ts-plex: {}
  ts-prowlarr: {}
  ts-radarr: {}
  ts-sabnzbd: {}
  ts-sonarr: {}
  ts-syncthing: {}
  ts-tautulli: {}

services:

  ts-nginx:
    <<: *tailscale
    environment:
      TS_HOSTNAME: nginx
      TS_SERVE_CONFIG: /config/nginx.json
    volumes:
      - ts-nginx:/var/lib/tailscale
    ports:
      - 80:80/tcp
      - 443:443/tcp

  ts-duplicati:
    <<: *tailscale
    environment:
      TS_HOSTNAME: duplicati
      TS_SERVE_CONFIG: /config/duplicati.json
    volumes:
      - ts-duplicati:/var/lib/tailscale

  ts-jellyfin:
    <<: *tailscale
    environment:
      TS_HOSTNAME: jellyfin
      TS_SERVE_CONFIG: /config/jellyfin.json
    volumes:
      - ts-jellyfin:/var/lib/tailscale

  ts-nzbhydra:
    <<: *tailscale
    environment:
      TS_HOSTNAME: nzbhydra
      TS_SERVE_CONFIG: /config/nzbhydra.json
    volumes:
      - ts-nzbhydra:/var/lib/tailscale

  ts-netdata:
    <<: *tailscale
    environment:
      TS_HOSTNAME: netdata
      TS_SERVE_CONFIG: /config/netdata.json
    volumes:
      - ts-netdata:/var/lib/tailscale

  ts-ombi:
    <<: *tailscale
    environment:
      TS_HOSTNAME: ombi
      TS_SERVE_CONFIG: /config/ombi.json
    volumes:
      - ts-ombi:/var/lib/tailscale

  ts-overseerr:
    <<: *tailscale
    environment:
      TS_HOSTNAME: overseerr
      TS_SERVE_CONFIG: /config/overseerr.json
    volumes:
      - ts-overseerr:/var/lib/tailscale

  ts-plex:
    <<: *tailscale
    environment:
      TS_HOSTNAME: plex
      TS_SERVE_CONFIG: /config/plex.json
    volumes:
      - ts-plex:/var/lib/tailscale

  ts-prowlarr:
    <<: *tailscale
    environment:
      TS_HOSTNAME: prowlarr
      TS_SERVE_CONFIG: /config/prowlarr.json
    volumes:
      - ts-prowlarr:/var/lib/tailscale

  ts-radarr:
    <<: *tailscale
    environment:
      TS_HOSTNAME: radarr
      TS_SERVE_CONFIG: /config/radarr.json
    volumes:
      - ts-radarr:/var/lib/tailscale

  ts-sabnzbd:
    <<: *tailscale
    environment:
      TS_HOSTNAME: sabnzbd
      TS_SERVE_CONFIG: /config/sabnzbd.json
    volumes:
      - ts-sabnzbd:/var/lib/tailscale

  ts-sonarr:
    <<: *tailscale
    environment:
      TS_HOSTNAME: sonarr
      TS_SERVE_CONFIG: /config/sonarr.json
    volumes:
      - ts-sonarr:/var/lib/tailscale

  ts-syncthing:
    <<: *tailscale
    environment:
      TS_HOSTNAME: syncthing
      TS_SERVE_CONFIG: /config/syncthing.json
    volumes:
      - ts-syncthing:/var/lib/tailscale
    ports:
      - 22000:22000/tcp
      - 22000:22000/udp
      - 21027:21027/udp

  ts-tautulli:
    <<: *tailscale
    environment:
      TS_HOSTNAME: tautulli
      TS_SERVE_CONFIG: /config/tautulli.json
    volumes:
      - ts-tautulli:/var/lib/tailscale

  # https://hub.docker.com/r/jc21/nginx-proxy-manager
  # https://github.com/NginxProxyManager/nginx-proxy-manager
  # https://nginxproxymanager.com/
  nginx:
    <<: *s6-service
    image: jc21/nginx-proxy-manager:2.11.3@sha256:5bd2aae54ac0b6f4ef6777143ab736baf5366807894a4c7fca7bfa2fbaf1489c
    volumes:
      - proxy:/data
      - letsencrypt:/etc/letsencrypt
    network_mode: service:ts-nginx
    depends_on:
      - ts-nginx

  # https://docs.linuxserver.io/images/docker-duplicati
  duplicati:
    <<: *s6-service
    image: lscr.io/linuxserver/duplicati:2.0.8@sha256:2cd598c5faa34476fb1fdbd9c652ddc67c8729f5f7cc9b11426d58c5e69d0c18
    environment:
      <<: *s6-environment
      PUID: "0"
      PGID: "0"
    volumes:
      - duplicati:/config
      # any volumes that might be worth backing up
      - syncthing:/volumes/syncthing
      - plex:/volumes/plex
      - sonarr:/volumes/sonarr
      - radarr:/volumes/radarr
      - nzbhydra:/volumes/nzbhydra
      - jellyfin:/volumes/jellyfin
      - prowlarr:/volumes/prowlarr
      - ombi:/volumes/ombi
      - overseerr:/volumes/overseerr
      - sabnzbd:/volumes/sabnzbd
      - downloads:/volumes/downloads
      - proxy:/volumes/proxy
      - tautulli:/volumes/tautulli
    network_mode: service:ts-duplicati
    depends_on:
      - ts-duplicati

  # https://docs.linuxserver.io/images/docker-jellyfin
  jellyfin:
    <<: *s6-service
    image: lscr.io/linuxserver/jellyfin:10.9.8@sha256:843878f35dc700e502798b39edb24b84b7b7ff0788f1b7b9b1e71d4f8d34f951
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - jellyfin:/config
      - downloads:/downloads
    network_mode: service:ts-jellyfin
    depends_on:
      - ts-jellyfin

  # https://docs.linuxserver.io/images/docker-nzbhydra
  nzbhydra:
    <<: *s6-service
    image: lscr.io/linuxserver/nzbhydra2:7.3.0@sha256:ed9c42e7425676809581c0a5057f538b88e7436a5cc3fff7163c90395b24d569
    volumes:
      - nzbhydra:/config
      - downloads:/downloads
    network_mode: service:ts-nzbhydra
    depends_on:
      - ts-nzbhydra

  # https://docs.linuxserver.io/images/docker-ombi
  ombi:
    <<: *s6-service
    image: lscr.io/linuxserver/ombi:4.44.1@sha256:f7eabee4800cd7a4716391aca11770563f5045f55cb10f2a397d94ac33d5f0b1
    volumes:
      - ombi:/config
    network_mode: service:ts-ombi
    depends_on:
      - ts-ombi

  # https://docs.linuxserver.io/images/docker-overseerr
  overseerr:
    <<: *s6-service
    image: lscr.io/linuxserver/overseerr:1.33.2@sha256:aaba9e51b62a17e914de79e8eda4616f12e9bf4bce115cda6d0ad8178daea102
    volumes:
      - overseerr:/config
    network_mode: service:ts-overseerr
    depends_on:
      - ts-overseerr

  # https://docs.linuxserver.io/images/docker-plex
  plex:
    <<: *s6-service
    image: lscr.io/linuxserver/plex:1.40.4@sha256:97d5d64e10850c67a2a694374b536a02f0e62bfae3b292ccfb8c07d6b1f0a79f
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - plex:/config
      - downloads:/downloads
    network_mode: service:ts-plex
    depends_on:
      - ts-plex

  # https://docs.linuxserver.io/images/docker-prowlarr
  prowlarr:
    <<: *s6-service
    image: lscr.io/linuxserver/prowlarr:1.21.1-develop@sha256:ea33c39fc13aaeccb2f7e6afd079d674a7aa5447bef921d0f4d3fa4caf209a35
    volumes:
      - prowlarr:/config
      - downloads:/downloads
    network_mode: service:ts-prowlarr
    depends_on:
      - ts-prowlarr

  # https://docs.linuxserver.io/images/docker-radarr
  radarr:
    <<: *s6-service
    image: lscr.io/linuxserver/radarr:5.7.0@sha256:1eaf9e83fca2b9170d4f49f6c0e55ba38693718e7815743a9ec297d199ab1e73
    volumes:
      - radarr:/config
      - downloads:/downloads
    network_mode: service:ts-radarr
    depends_on:
      - ts-radarr

  # https://docs.linuxserver.io/images/docker-sabnzbd
  sabnzbd:
    <<: *s6-service
    image: lscr.io/linuxserver/sabnzbd:4.3.2@sha256:31ea64a7ce1e9a5ff8187f9b7c905eaa1d0a79d49b04724e47059c67407157eb
    volumes:
      - sabnzbd:/config
      - downloads:/downloads
    network_mode: service:ts-sabnzbd
    depends_on:
      - ts-sabnzbd

  # https://docs.linuxserver.io/images/docker-sonarr
  sonarr:
    <<: *s6-service
    image: lscr.io/linuxserver/sonarr:4.0.8@sha256:fbee5770f688e4f89dd073534feda11251bfde0e0a4e6ac74dd8c33bb856b505
    volumes:
      - sonarr:/config
      - downloads:/downloads
    network_mode: service:ts-sonarr
    depends_on:
      - ts-sonarr

  # https://docs.linuxserver.io/images/docker-syncthing
  syncthing:
    <<: *s6-service
    image: lscr.io/linuxserver/syncthing:1.27.9@sha256:84e9cd99d247d6ef31fc8c1a6967f068a8352a530095bb402bf3bb298aa10696
    volumes:
      - syncthing:/config
      # any volumes that might be worth syncronizing between machines
      - plex:/volumes/plex
      - sonarr:/volumes/sonarr
      - radarr:/volumes/radarr
      - nzbhydra:/volumes/nzbhydra
      - jellyfin:/volumes/jellyfin
      - prowlarr:/volumes/prowlarr
      - ombi:/volumes/ombi
      - overseerr:/volumes/overseerr
      - sabnzbd:/volumes/sabnzbd
      - downloads:/volumes/downloads
      - proxy:/volumes/proxy
      - tautulli:/volumes/tautulli
    network_mode: service:ts-syncthing
    depends_on:
      - ts-syncthing

  # https://docs.linuxserver.io/images/docker-tautulli
  tautulli:
    <<: *s6-service
    image: lscr.io/linuxserver/tautulli:2.14.3@sha256:2928b639a673e739ff2f3f3613103b91e1a0e8bd53d19c37baff16474e4ed5f3
    volumes:
      - tautulli:/config
    network_mode: service:ts-tautulli
    depends_on:
      - ts-tautulli

  # https://hub.docker.com/r/netdata/netdata
  netdata:
    image: netdata/netdata:v1.46.2@sha256:ea5a256b29ec592e7a13103d1632bfea0ce58365732d04c8fd32c8d740d3b1fb
    restart: "on-failure"
    privileged: true
    cap_add:
      - SYS_PTRACE
    environment:
      DOCKER_HOST: "/var/run/balena.sock"
      PGID: "990" # ls -nd /var/run/balena.sock | awk '{print $4}'
    labels:
      io.balena.features.balena-socket: 1
      io.balena.features.procfs: 1
      io.balena.features.sysfs: 1
    security_opt:
      - apparmor:unconfined
    tmpfs:
      - /tmp
    volumes:
      - netdatalib:/var/lib/netdata
      - netdatacache:/var/cache/netdata
    network_mode: service:ts-netdata
    depends_on:
      - ts-netdata
